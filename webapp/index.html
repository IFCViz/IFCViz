<html>
<head>
    <script>
        /**
        * Simple utility function to create a visible error message
        */
        function create_error_message(message){
            let text_box = document.createElement("div");
            text_box.classList.add("error-message");

            let text_element = document.createElement("p");
            text_element.textContent = message;
            text_box.appendChild(text_element);
            document.body.appendChild(text_box);
        }

        /**
        * Helper function, displays information about floors
        */
        function display_floors(model){
            let floor_box = document.createElement("div");
            floor_box.id = "ifc-information-container";
            
            let label = document.createElement("h4");
            label.id = "ifc-information-container-label";
            label.textContent = "Floor Information";
            floor_box.appendChild(label);

            let floors = model.floors;
            console.log(model, floors);
            for (const [i, v] of floors.entries()){
                let text_element = document.createElement("p");
                text_element.textContent = JSON.stringify(v);
                floor_box.appendChild(text_element);
            }
            let app_obj = document.getElementById("app");
            let mid_region_obj = document.getElementById("mid_region");
            let drop_target_obj = document.getElementById("drop_target");
            mid_region_obj.insertBefore(floor_box, drop_target_obj);
        }

        function display_extraction(extraction){
            let model_name = "Some model name";
            let model = extraction[model_name];
            display_floors(model);
        }

        /** 
        * When dropping a file into the browser window, this prevents the default
        * behaviour - that the browser opens the file in a new window.
		*/
         function allowDrop(ev) {
            ev.preventDefault();
        }

        /**
        * This function is called on-drop
        */
         function handleDrop(event) {
            event.preventDefault();

            const file = event.dataTransfer.files[0];

            if (file) {
                upload_and_present(file);
            }
        }

        //Taking a file object and returning a gzipped blob
        async function gzip_file(file){
            const readableFileStream = file.stream();
            const compressedFileStream = readableFileStream.pipeThrough(
                new CompressionStream("gzip"),
            );
            const compressedResponse = await new Response(compressedFileStream);
            const blob = await compressedResponse.blob();
            return blob;
        }

        //Taking a gzipped blob object and returns an unzipped blob object
        async function ungzip_blob(gzipped_blob){
            const decompressedReadableStream = gzipped_blob.stream().pipeThrough(
                new DecompressionStream('gzip')
            );
            const decompressedResponse = await new Response(decompressedReadableStream);
            const blob = await decompressedResponse.blob();
            return blob;
        }

        //Just a utility function that console logs a text file
        async function log_textfile(text_file){
            const freader = new FileReader();
            freader.onload = (evt) => {
                console.log(evt.target.result);
            }
            freader.readAsText(text_file);
        }

        //Takes a file and uploads to /upload endpoint, returns the response from the server
        async function uploadFile(file) {
            const blob = await gzip_file(file);
            let response;
            response = await fetch('http://localhost:5000/upload',{
                method: 'POST',
                body: blob
            });
            if(response.ok == false){
                create_error_message("Error uploading file!");
                console.log(response.error);
                return null;
            }
            return (await response.json()).fileid;
        }

        //Returning the extracted information from the IFC-file 
        //associated with the given file hash
        async function get_metadata(file_hash){
            let response = await fetch('http://localhost:5000/metadata/' + file_hash, {
                method: 'GET'
            });
            if(response.ok == false){
                create_error_message("Error! Could not get metadata!!");
                console.log(response.error);
                return null;
            }

            let extraction = await response.json();
            return extraction;
        }

        async function request_and_present(file_hash){
            const received_file = await request_file(file_hash);
            //await log_textfile(received_file);
        }
        
        //A function that will upload a file, get the response, and present it in the client's browser
        async function upload_and_present(file){
            const file_hash = await uploadFile(file);
            console.log("value: " + JSON.stringify(file_hash, null, 2));
            
            //response.fileid is the hash
            await request_and_present(file_hash);
            console.log(await get_metadata(file_hash));
            display_extraction(await get_metadata(file_hash));
            
            /*
            ifc_info = JSON.parse(response.value)["my_list"];
            let containerDiv = document.createElement('div');
            containerDiv.classList.add('info-container');

            for (let i = 0; i < ifc_info.length; i++) {
                Object.keys(ifc_info[i]).forEach(function(k) {
                    let infoDiv = document.createElement('div');
                    infoDiv.classList.add('info-div');

                    let keySpan = document.createElement('span');
                    keySpan.classList.add('info-key');
                    keySpan.innerText = k + ': ';

                    let valueSpan = document.createElement('span');
                    valueSpan.classList.add('info-value');
                    valueSpan.innerText = ifc_info[i][k] + " kvm";

                    infoDiv.appendChild(keySpan);
                    infoDiv.appendChild(valueSpan);
                    containerDiv.appendChild(infoDiv);
                });
            }
            document.getElementById('container').appendChild(containerDiv) 
            */ 
        }

        //Returns the entirety of the file associated with the given file hash.
        async function request_file(file_hash){
            let response;
            response = await fetch("http://localhost:5000/receive/" + file_hash, {
                method: "GET"
            })
            if(response.ok == false){
                create_error_message("Failed to recieve file");
                console.error(response.error);
                return null;
            }
            response = await response.blob();

            console.log(response);
            const parsed_blob = await ungzip_blob(response);
            const new_file = new File([parsed_blob], "../requested_files/"+file_hash+".txt", {type:"text/plain"});
            return new_file;
        }

             
    </script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</head>

<body>
<div id="app">
    <div style="width: 100%; opacity: 100%; display: inline-grid; align-items: center; justify-items: center; grid-template-columns: 0.4fr 0.4fr 1.4fr; margin-top: 0">
        <img style="width: 45%" src="https://intra.kth.se/img/logotype-blue-ff671d438dd60cb940a663d2fd5e0cf9.svg"/>
        <img style="width: 100%; padding-top: 2%" src="https://api2.envirobase.se/api/V1/MediaFile/Contained/480x320x30/ffffff/2819/"/>

        <p></p>

    </div>
<div id = "mid_region" style="height: 75%; display:grid; grid-template-rows: 0.2fr 0.8fr; align-items: center;">
    <div>
        <h1 style="margin-top: 0 a">IFCViz</h1> 
        <p> 
            Drop your IFC file onto this window to have it analyzed by our proprietary bipavisionâ„¢ technology.
            This service is provided without warranty.
        </p>
    </div>
    
    <div
        id="droptarget" 
	ondragover="allowDrop(event)"
        ondrop="handleDrop(event)"
        style="border: 2px dashed #ccc; padding: 20px;"
    >
        Drop your file here
    </div>
    <div id="container">
    
    </div>
</div>
    <br>
    <div style="width: 35em; position: absolute; left: 50%; transform: translateX(-50%); bottom: 3em; display: inline-grid; grid-template-columns: 1fr 0.1fr 1fr; margin-top: 20%; gap: 0.75em">
    <button onclick="alert(atob('WU9VIEFDS05PV0xFREdFIEFORCBBR1JFRSBUSEFUIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBUTyBZT1UgT04gQU4gIkFTIElTIiBCQVNJUy4KVEhFIExJQ0VOU09SIERJU0NMQUlNUyBBTlkgQU5EIEFMTCBSRVBSRVNFTlRBVElPTlMgQU5EIFdBUlJBTlRJRVMsIEVYUFJFU1MgT1IgSU1QTElFRApJTkNMVURJTkcgKFdJVEhPVVQgTElNSVRBVElPTikgQU5ZIElNUExJRUQgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksIE9SIEhBUkRXQVJFCk9SIFNPRlRXQVJFIENPTVBBVElCSUxJVFksIE9SIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIE9SIFVTRSwgSU5DTFVESU5HIFlPVVIKUEFSVElDVUxBUiBCVVNJTkVTUyBPUiBJTlRFTkRFRCBVU0UsIE9SIE9GIFRIRSBTT0ZUV0FSRSdTIFJFTElBQklMSVRZLCBQRVJGT1JNQU5DRSBPUgpDT05USU5VRUQgQVZBSUxBQklMSVRZLiBUSEUgTElDRU5TT1IgRE9FUyBOT1QgUkVQUkVTRU5UIE9SIFdBUlJBTlQgVEhBVCBUSEUKU09GVFdBUkUgT1IgQ0FMQ1VMQVRJT05TIE9SIFBSSU5UUyBPUiBFWFBPUlQgREFUQSBNQURFIFRIRVJFT0YgV0lMTCBCRSBGUkVFIEZST00KVklSVVNFUywgTUFMV0FSRSwgVFJPSkFOIEhPUlNFUyBPUiBBTlkgT1RIRVIgREVGRUNUUyBPUiBFUlJPUlMgQU5EIFRIQVQgQU5ZIFNVQ0gKRUZGRUNUUyBPUiBFUlJPUlMgV0lMTCBCRSBDT1JSRUNURUQsIE9SIFRIQVQgSVQgV0lMTCBPUEVSQVRFIFdJVEhPVVQgSU5URVJSVVBUSU9OLgpZT1UgQUdSRUUgVEhBVCBZT1UgQVJFIFNPTEVMWSBSRVNQT05TSUJMRSBGT1IgQUxMIENPU1RTIEFORCBFWFBFTlNFUyBBU1NPQ0lBVEVECldJVEggUkVDVElGSUNBVElPTiwgUkVQQUlSIE9SIERBTUFHRSBDQVVTRUQgQlkgU1VDSCBERUZFQ1RTLCBFUlJPUlMgT1IgSU5URVJSVVBUSU9OUy4KRlVSVEhFUiwgVEhFIExJQ0VOU09SIERPRVMgTk9UIFJFUFJFU0VOVCBBTkQgV0FSUkFOVCBUSEFUIFRIRSBTT0ZUV0FSRSBET0VTIE5PVApJTkZSSU5HRSBUSEUgSU5URUxMRUNUVUFMIFBST1BFUlRZIFJJR0hUIE9GIEFOWSBPVEhFUiBQRVJTT04uIFlPVSBBQ0NFUFQKUkVTUE9OU0lCSUxJVFkgVE8gVkVSSUZZIFRIQVQgVEhFIFNPRlRXQVJFIE1FRVRTIFlPVVIgU1BFQ0lGSUMgUkVRVUlSRU1FTlRTLg=='));">Statement of limitations</button>
    <p></p>
    <button onclick="location.href='mailto:smonten@kth.se'">Contact</button>
    </div>
</div>  

<style>
    .info-container {
        display: flex;
        flex-direction: column;
        margin-top: 20px;
    }

    .info-div {
        display: flex;
        justify-content: space-between;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 5px;
    }

    .info-key {
        font-weight: bold;
    }

    .info-value {
        color: #555;
    }
    #app {
        text-align: center;
    }

    button {
        font-size: 16px;
        padding: 10px 20px;
        margin-bottom: 20px;
        cursor: pointer;
        background-color: #4caf50;
        color: #fff;
        border: none;
        border-radius: 4px;
    }

    button:hover {
        background-color: #45a049;
    }

    #file-drop-area {
        border: 2px dashed #ccc;
        padding: 20px;
        margin-top: 20px;
        cursor: pointer;
    }

    #ifc-information-container{
        border: 2px dashed #ccc;
        padding: 20px;
        margin-top: 20px;
    }
    
    #ifc-information-container-label{
        font-size: 16px;
        background-color: #ebeff5;
        border-radius: 10px;
        /* border-width: 2px; */
        border-color: f5f5f5;
        /* border-style: dashed; */
        text-align: center;
        padding-top: 0px;
        margin-top: 0px;
    }

    .ifc-information{
        text-align: left;
    }

    pre {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow: auto;
        max-width: 600px;
        margin: 20px auto;
    }

    .error-message{
        width: 250px;
        height: 20px;
        background-color: black;
        color: #ff0000; /* Red color for error messages */
        font-weight: bold; /* Make the text bold */
        margin-bottom: 10px; /* Add some bottom margin to separate messages */
    }

</style>
</body>
</html>


